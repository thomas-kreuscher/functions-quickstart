trigger:
  branches:
    include:
      - master

pool:
  name: SelfHostedPool

steps:
- script: echo "Deploying commit $(Build.SourceVersion) to Function App"
  displayName: 'Agent-Check'

# Staging vorbereiten
- powershell: |
    $staging = "$(Build.ArtifactStagingDirectory)\functions_staging"
    if (Test-Path $staging) { Remove-Item $staging -Recurse -Force }
    New-Item -ItemType Directory -Path $staging | Out-Null
    # host.json ins Root kopieren
    Copy-Item "$(Build.SourcesDirectory)\host.json" $staging -Force
    # Funktionsordner kopieren
    Copy-Item "$(Build.SourcesDirectory)\HttpTriggerCSharp1" $staging -Recurse -Force
    Copy-Item "$(Build.SourcesDirectory)\HttpTriggerJS1" $staging -Recurse -Force
    Copy-Item "$(Build.SourcesDirectory)\HttpTriggerFSharp1" $staging -Recurse -Force
  displayName: 'Prepare staging with host.json at root'

# ZIP erstellen
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/functions_staging'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/functions.zip'
    replaceExistingArchive: true
  displayName: 'Archive staging to ZIP'

# Debug: ZIP-Inhalt pr√ºfen
- powershell: |
    Expand-Archive -Path "$(Build.ArtifactStagingDirectory)/functions.zip" -DestinationPath "$(Build.ArtifactStagingDirectory)/unzipped"
    Get-ChildItem -Recurse "$(Build.ArtifactStagingDirectory)/unzipped"
  displayName: 'Check ZIP contents'

# Deploy via Azure CLI
- task: AzureCLI@2
  inputs:
    azureSubscription: 'AzureConnection'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      $zipPath = "$(Build.ArtifactStagingDirectory)/functions.zip"
      az functionapp deployment source config-zip `
        --resource-group az400-123456789-func1_rg `
        --name az400-123456789-func1 `
        --src $zipPath








